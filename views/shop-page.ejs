<%-include('includes/header')%>
<link rel="stylesheet" type="text/css" href="/css/shop.css" />

<body>
  <div class="shop_navbar">
    <div class="nav_container">
      <h2 class="page_name">Shop Page</h2>
      <div class="nav_link_wrap">
        <a href="/admin" class="nav_link">Home</a>
        <a href="/admin/shop-control" class="nav_link">My Products</a>
        <a href="/admin/shop-control" class="nav_link">My Clients</a>

        <a href="/admin/logout" class="nav_link">Log out</a>
      </div>
      <div class="nav_right">
        <div class="message_wrap">
          <img class="message_icon" src="/images/message.svg" alt="email" />
          <span class="message_cnt">
            <p>4</p>
          </span>
        </div>
        <img class="user_img" src="/images/default_shop.jpeg" alt="avatar" />
        <p class="user_name"><%= member.mb_nick %></p>
      </div>
    </div>
  </div>
  <div class="shop_content_wrap">
    <div class="shop_content">
      <h2 class="content_title">All Product Status</h2>
      <table class="table table-bordered table-hover">
        <thead class="thead-light">
          <th scope="col">N</th>
          <th scope="col">Product name</th>
          <th scope="col">Product type</th>
          <th scope="col">Product price</th>
          <th scope="col">Product discount</th>
          <th scope="col">Discount period</th>
          <th scope="col">Product left count</th>
          <th scope="col">Product status</th>
          <th scope="col">Edit product</th>
        </thead>
        <% shop_data.map((value, key) => { %>
        <tbody id="<%= value._id %>" class="products_table_body">
          <td><%= key + 1 %></td>
          <td><%= value.product_name%></td>
          <td><%= value.product_collection%></td>
          <td><%= value.product_price%></td>
          <td><%= value.product_discount%></td>
          <td><%= value.product_discount_period%></td>
          <td><%= value.product_left_cnt%></td>
          <td><%= value.product_status%></td>
          <td>
            <a
              style="text-decoration: none"
              class="edit_link"
              href="/admin/products/edit/<%= value._id %>"
              >Edit</a
            >
          </td>
        </tbody>
        <%});%>
      </table>
      <div class="add_btn_wrap">
        <button class="btn btn-primary hiding_btn">Add New Product</button>
      </div>
      <!-- ADD NEW PRODUCT FORM START -->

      <!-- <form
        onsubmit="return validateForm()"
        action="/admin/products/create"
        method="POST"
        class="item_container"
        enctype="multipart/form-data"
      >
        <h2 class="new_dish_txt">Add New Product</h2>

        <div>
          <div class="long_input">
            <label for="product_name">Product name:</label>
            <input
              id="product_name"
              type="text"
              placeholder="ex: Dog bag"
              name="product_name"
              class="product_name"
              autocomplete="off"
            />
          </div>
          <input
            type="text"
            name="product_status"
            value="PAUSED"
            class="product_status"
            hidden
          />
        </div>
        <div class="half_input_frame">
          <div class="half_input">
            <label for="product_price">Taom narxi</label>
            <input
              id="product_price"
              type="number"
              placeholder="Taom narxi"
              name="product_price"
              class="product_price"
            />
          </div>
          <div class="half_input">
            <label for="product_left_cnt">Taom Qoldiq Miqdori</label>
            <input
              id="product_left_cnt"
              type="number"
              placeholder="Taom Mavjud Miqdori"
              name="product_left_cnt"
              class="product_left_cnt"
            />
          </div>
        </div>
        <div class="half_input_frame">
          <div class="half_input">
            <label for="">Taom Turi</label>
            <select class="product_collection" name="product_collection">
              <option value="dish" select>Taom</option>
              <option value="salad">Salad</option>
              <option value="dessert">Dessert</option>
              <option value="drink">Ichimlik</option>
              <option value="etc">Boshqa</option>
            </select>
          </div>
          <div class="half_input" id="product_size">
            <label>Taom Hajmi</label>
            <select class="product_size" name="product_size">
              <option value="small">Kichkina</option>
              <option value="normal" selected>O'rtacha</option>
              <option value="large">Katta</option>
              <option value="set">Set</option>
            </select>
          </div>
          <div class="half_input" id="product_volume" style="display: none">
            <label>Ichimlik Hajmi</label>
            <select class="product_volume" name="product_volume">
              <option value="0.5">0.5 L</option>
              <option value="1" selected>1 L</option>
              <option value="1.2">1.2 L</option>
              <option value="1.5">1.5 L</option>
              <option value="2">2 L</option>
            </select>
          </div>
        </div>

        <div class="long_input">
          <label for="product_description">Taom Haqida</label>
          <textarea
            name="product_description"
            class="product_description"
            id="product_description"
          ></textarea>
        </div>

        <div class="img_frame">
          <label for="">Taom Rasmlari</label>
          <div class="media-frame">
            <div class="upload_img_box">
              <img
                src="/images/upload.svg"
                class="1"
                id="image_section_1"
                alt="dish"
              />
              <input
                type="file"
                name="product_images"
                class="image_one"
                id="file"
                onchange="previewFileHandler(this, 1)"
              />
            </div>
            <div class="upload_img_box">
              <img
                src="/images/upload.svg"
                class="2"
                id="image_section_2"
                alt="dish"
              />
              <input
                type="file"
                name="product_images"
                class="image_two"
                id="file"
                onchange="previewFileHandler(this, 2)"
              />
            </div>
            <div class="upload_img_box">
              <img
                src="/images/upload.svg"
                class="3"
                id="image_section_3"
                alt="dish"
              />
              <input
                type="file"
                name="product_images"
                class="image_three"
                id="file"
                onchange="previewFileHandler(this, 3)"
              />
            </div>
            <div class="upload_img_box">
              <img
                src="/images/upload.svg"
                class="4"
                id="image_section_4"
                alt="dish"
              />
              <input
                type="file"
                name="product_images"
                class="image_four"
                id="file"
                onchange="previewFileHandler(this, 4)"
              />
            </div>
            <div class="upload_img_box">
              <img
                src="/images/upload.svg"
                class="5"
                id="image_section_5"
                alt="dish"
              />
              <input
                type="file"
                name="product_images"
                class="image_five"
                id="file"
                onchange="previewFileHandler(this, 5)"
              />
            </div>
            <input
              type="text"
              value="<%= member._id%>"
              name="restaurant_id"
              class="restaurant_id"
              hidden
            />
          </div>
        </div>
        <div
          class="long_input"
          style="align-items: flex-end; margin-bottom: 25px"
        >
          <button class="btn btn-primary" id="create_product" type="submit">
            Chop Etish
          </button>
        </div>
      </form> -->

      <!-- ADD DISH FORM END -->
    </div>
  </div>
</body>
<script>
  $(function () {
    $(".hiding_btn").on("click", () => {
      $(".item_container").slideToggle(500);
      $(".hiding_btn").hide();
    });

    $(".product_collection").on("change", () => {
      const selected_value = $(".product_collection").val();
      if (selected_value === "drink") {
        $("#product_volume").show();
        $("#product_size").hide();
      } else {
        $("#product_volume").hide();
        $("#product_size").show();
      }
    });

    // product status changer

    $(".new_product_status").on("change", async function (e) {
      const id = e.target.id;
      const product_status = $(`#${id}.new_product_status`).val();
      try {
        const response = await axios.post(`/resto/products/edit/${id}`, {
          id: id,
          product_status: product_status,
        });
        const result = response.data;
        console.log("result: ", result);
        if (result.state == "success") {
          alert("success");
          location.reload();
        } else {
          alert(result.message);
        }
      } catch (err) {
        console.log("updateChosenproduct", err);
      }
    });
  });

  function validateForm() {
    const restaurant_mb_id = $(".restaurant_mb_id").val(),
      product_name = $(".product_name").val(),
      product_price = $(".product_price").val(),
      product_left_cnt = $(".product_left_cnt").val(),
      product_collection = $(".product_collection").val(),
      product_description = $(".product_description").val(),
      product_status = $(".product_status").val();

    if (
      restaurant_mb_id == "" ||
      product_name == "" ||
      product_price == "" ||
      product_left_cnt == "" ||
      product_collection == "" ||
      product_description == "" ||
      product_status == ""
    ) {
      alert("Iltimos hamma ma'lumotlarni kiriting!");
      return false;
    } else return true;
  }

  function previewFileHandler(input, order) {
    const image_class_name = input.className;
    const file = $(`.${image_class_name}`).get(0).files[0],
      fileType = file["type"],
      validImageTypes = ["image/jpg", "image/jpeg", "image/png"];

    if (!validImageTypes.includes(fileType)) {
      alert(
        "Iltimos ruxsat etilgan formatdagi rasmlarni yuklang! (jpg, jpeg, png)"
      );
    } else {
      let reader = new FileReader();
      reader.onload = function () {
        $(`#image_section_${order}`).attr("src", reader.result);
      };
      reader.readAsDataURL(file);
    }
  }
</script>

<%-include('includes/footer')%>
